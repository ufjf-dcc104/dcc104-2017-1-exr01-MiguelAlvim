<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Moonlander</title>
	<script src="sprite.js" charset="utf-8">	</script>
	<script src="bar.js" charset="utf-8">	</script>
	<script src="imgLoader.js" charset="utf-8">	</script>
  </head>
  <body >
	<canvas height=300 width=1200>
		<script>
			//Control Vars
			var eCanvas = document.getElementsByTagName("Canvas")[0];
			var ctx = eCanvas.getContext("2d");			
			var dateActual = new Date();
			var dateBefore = new Date();
			var fps = 60;
			var deltaTime = 1/fps;
			var timeElapsed =0;
			var gameON = true;
			var gameFinished = false;
			var score = 0;
			
			var imgs = new ImgLoader();
			
			imgs.addImg("img/spaceshipset32x32/player_ship.png","ship01")
			
			//Objects on the Scene
			var blue = new Sprite();
				blue.accGravityY = 0.5;
				blue.x=550;
				blue.y=100;
				blue.h=0;
				blue.w=0;
				blue.angle=0;
				blue.turnSpeed=40;
			var verticalThrusterFuel = new Bar();
				verticalThrusterFuel.x = 10;
				verticalThrusterFuel.y = 10;
				verticalThrusterFuel.height = 10;
				verticalThrusterFuel.width = 100;
				verticalThrusterFuel.maxValue = 100;
				verticalThrusterFuel.actualValue = 100;
			var floorFields = new Array(3);
				floorFields[0] = new Array(4);
				floorFields[1] = new Array(4);
				floorFields[2] = new Array(4);
				floorFields[0][0] = 10;
				floorFields[0][1] = 250;
				floorFields[0][2] = 120;
				floorFields[0][3] = 250;
				
				floorFields[1][0] = 1000;
				floorFields[1][1] = 200;
				floorFields[1][2] = 1200;
				floorFields[1][3] = 200;	
				
			
			
			//DEBUG VARS
			var DEBUG = false;
				
			//MAIN LOOPING FUNCTION
			draw();
			
			function draw(){
				requestAnimationFrame(draw);
				dateBefore = dateActual;
				dateActual = new Date();
				deltaTime = (dateActual - dateBefore)/1000;
				
				cleanCanvas();
				
				ctx.drawImage(imgs.images["ship01"],100,100);
				
				ctx.fillStyle = "BLACK";
				if(gameON){
					//SHIP DRAWN AND MOVE
					if(!gameFinished)
						blue.move(deltaTime);
					blue.draw(ctx);					
					//COLLISION
					if(checkCollisions() && !gameFinished){	
						if(blue.vely < 1.01){
							blue.accGravityY = 0;
							blue.accy = 0;					
							blue.accCounterY = 0;	
							blue.vely = 0;
							gameFinished = true;
							score = ((verticalThrusterFuel.actualValue/verticalThrusterFuel.maxValue)*1000*(4/timeElapsed)).toFixed(0);
						}else{//S** hitted the fan, explode the ship
							gameON = false;
						}
					}
					if(checkOutOfBounds())
						gameON = false;
					if(gameFinished){//MISSION COMPLETE; SUCCESS
							ctx.fillText("Victory",eCanvas.width/2,eCanvas.height/2);
							ctx.fillText("Score: "+score,eCanvas.width/2,eCanvas.height/2+20);
						}
				}else{
					//GAME OVER
					ctx.fillText("Game Over",eCanvas.width/2,eCanvas.height/2);
				}
				
				//HUD
				verticalThrusterFuel.draw(ctx);
				ctx.fillText("AccX: "+(blue.accx+blue.accCounterX+blue.accGravityX).toFixed(4) +" VelX:"+blue.velx.toFixed(4),10,30);
				ctx.fillText("AccY: "+-(blue.accy+blue.accCounterY+blue.accGravityY).toFixed(4) +" VelY:"+-blue.vely.toFixed(4),10,40);
				ctx.fillText("Time: "+ (timeElapsed).toFixed(2) + " s",10,50);
				
				//LANDING LINES
				drawLandingLines();
				drawBoundryBox();
				
				//Counting Time				
				if(!gameFinished && gameON)
					timeElapsed += deltaTime;
				//DEBUG STUFF
				if(DEBUG){
					var DEBUGx = 200;
					var DEBUGy = 9;
					ctx.fillStyle = "BLACK";
					ctx.fillText("Counter ACCX: "+blue.accCounterX.toFixed(4)+"  Counter ACCY: "+blue.accCounterY.toFixed(4)+
					"  Gravity Y: "+blue.accGravityY.toFixed(4),DEBUGx,DEBUGy);
					ctx.fillText("DT: "+deltaTime.toFixed(2)+" ms",DEBUGx,10+DEBUGy);
					ctx.fillText("FPS: "+(1/deltaTime).toFixed(2),DEBUGx,20+DEBUGy);
					ctx.fillText("AccX: "+(blue.accx+blue.accCounterX+blue.accGravityX).toFixed(4) +"  VelX:"+blue.velx.toFixed(4),DEBUGx,30+DEBUGy);
					ctx.fillText("AccY: "+(blue.accy+blue.accCounterY+blue.accGravityY).toFixed(4) +"  VelY:"+blue.vely.toFixed(4),DEBUGx,40+DEBUGy);
					ctx.fillText("X: "+blue.x.toFixed(2) +"  Y:"+blue.y.toFixed(2),DEBUGx,50+DEBUGy);
					ctx.fillText(floorFields[0][0]+"  "+floorFields[0][1],DEBUGx,60+DEBUGy);
					ctx.fillText(floorFields[0][2]+"  "+floorFields[0][3],DEBUGx,70+DEBUGy);
					ctx.fillText(floorFields[1][0]+"  "+floorFields[1][1],DEBUGx,80+DEBUGy);
					ctx.fillText(floorFields[1][2]+"  "+floorFields[1][3],DEBUGx,90+DEBUGy);
					//console.log((1/deltaTime).toFixed(2));
				}
			}
			
			function checkOutOfBounds(){
				if(blue.x+22 >= eCanvas.offsetWidth){
					blue.x = eCanvas.offsetWidth-22;
					return true;
				}
				if(blue.x-7 <0){
					blue.x = 7;
					return true;
				}
				if(blue.y+36 >= eCanvas.offsetHeight){
					blue.y = eCanvas.offsetHeight-36;
					blue.vely = 0;
					blue.accy = 0;
					blue.accGravityY = 0;
					blue.accCounterY = 0;
					return true;
				}
				if(blue.y <0){
					blue.y = 1;
					blue.vely = 0;
					blue.accy = 0;
					blue.accCounterY = 0;
					return true;
				}
				return false;
			}
			
			function checkCollisions(){
				for(var i=0;i<floorFields.length;i++){
					if(blue.touchLandingGearLine(floorFields[i][0],floorFields[i][1],floorFields[i][2],floorFields[i][3])){
						//console.log("COLLISION!");
						return true;
					}
				}
				return false;
			}
			
			function drawLandingLines(){
			ctx.strokeStyle = "PURPLE";	
			ctx.lineWidth=1.5;
				for(var i=0;i<floorFields.length;i++){
					ctx.beginPath();
						ctx.moveTo(floorFields[i][0],floorFields[i][1]);
						ctx.lineTo(floorFields[i][2],floorFields[i][3]);
					ctx.stroke();
				}
			ctx.lineWidth=1.0; 
			ctx.fillStyle = "BLACK";
			}
			
			function drawBoundryBox(){		
				ctx.fillStyle = "black";
				ctx.strokeStyle = "black";	
				ctx.strokeRect(0,0,eCanvas.width-1,eCanvas.height-1);
			}
			
			function cleanCanvas(){
				ctx.clearRect(0,0,eCanvas.width,eCanvas.height)
			}
				
			addEventListener("keydown", function(e){
				//console.log("-------------------PRESSED-------------------");
				//console.log(e.keyCode);
				switch(e.keyCode){
					case 37:{//left
						blue.accx +=-20*deltaTime;
						blue.addACCX(-20*deltaTime);
						blue.leftMoveActivated = true;
						//blue.angle+=-blue.turnSpeed*deltaTime;
					}break;
					case 38:{//Up
						if(verticalThrusterFuel.actualValue>0 && gameON){
							blue.accGravityY = 0.5;
							blue.addACCY(-20*deltaTime);
							blue.accAng += 0.5*deltaTime;
							blue.upMoveActivated = true;
							verticalThrusterFuel.actualValue -= 20*deltaTime;
							if(verticalThrusterFuel.actualValue<0)
								verticalThrusterFuel.actualValue =0;
						}else{
							blue.upMoveActivated = false;
						}
					}break;
					
					case 39:{//Right
						blue.accx +=20*deltaTime;
						blue.addACCX(20*deltaTime);
						blue.rightMoveActivated = true;
						//blue.angle+=blue.turnSpeed*deltaTime;
					}break;
					
					case 40:{//Down
						//blue.accy +=20*deltaTime;
						//blue.addACCY(20*deltaTime);
						//blue.downMoveActivated = true;
					}break;
					case 112:{//F1
						DEBUG=!DEBUG;
					}break;
				}
			});
			addEventListener("keyup", function(e){
				//console.log(e.keyCode);
				switch(e.keyCode){
					case 37:{//left
						blue.leftMoveActivated = false;
					}break;
					case 38:{//uP
						blue.upMoveActivated = false;
					}break;
					
					case 39:{//right
						blue.rightMoveActivated = false;
					}break;
					
					case 40:{//Down
						blue.downMoveActivated = false;
					}break;
				}
			});

		</script>
	</canvas>
  </body>
</html>
